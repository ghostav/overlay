[[ "$CATEGORY" = "sys-kernel" ]] || die "$0: must be called for kernel package"
[[ "${PN%-sources}" = "$PN" ]]   || die "$0: must be called for sources package"

[[ "${EBUILD_PHASE}" = 'preinst' ]] || return

# 1:wireguard-path 2:kernel-path 3:kernel-version
function ghostav_bashrc_wireguard_install() {
	[[ -n "${3}" ]] || die "$0: KV_FULL not set"
	[[ -e "${1}" ]] || die "$0: could not find wireguard source"
	[[ -e "${D}/${2}/net/Kconfig" ]] || die "$0: could not find network Kconfig in ${2}"

	einfo	"applying wireguard patches for ${2}"
	printf	'obj-$(CONFIG_WIREGUARD)\t+= %s\n' "${1}" >> "${D}/${2}/net/Makefile"
	sed -i	"/^if INET\$/a source \"${1}/Kconfig\"" "${D}/${2}/net/Kconfig"
	grep -qF "source \"${1}/Kconfig\"" "${D}/${2}/net/Kconfig" \
		|| die "$0: could not insert Kconfig to ${2}/net/Kconfig"
}

ghostav_bashrc_wireguard_install "/usr/src/wireguard" "/usr/src/linux-${KV_FULL}" "${KV_FULL}"
